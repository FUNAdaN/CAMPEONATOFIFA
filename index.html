<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC25 Guri Pro - Oficial</title>
    <style>
        :root { --gold: #f3ad0e; --dark: #05070a; --panel: #11151f; --accent: #1e2533; --green: #27ae60; --red: #e74c3c; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--dark); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        
        .tabs { display: flex; gap: 5px; width: 100%; max-width: 600px; position: sticky; top: 0; z-index: 100; background: var(--dark); padding: 10px 0; }
        .tab-btn { background: var(--panel); color: #888; border: 1px solid #333; padding: 12px 5px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 0.7em; flex: 1; text-align: center; }
        .tab-btn.active { background: var(--gold); color: black; border-color: var(--gold); }

        .content-section { display: none; width: 100%; max-width: 600px; }
        .content-section.active { display: block; }

        .card { background: var(--panel); border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; padding: 15px; width: 100%; }
        table { width: 100%; border-collapse: collapse; background: #0d1117; border-radius: 8px; overflow: hidden; font-size: 0.8em; }
        th { background: var(--accent); color: var(--gold); padding: 10px; }
        td { padding: 8px; text-align: center; border-bottom: 1px solid #222; }

        .logo-img { width: 22px; height: 22px; vertical-align: middle; }
        .score-input { width: 45px; height: 35px; text-align: center; color: var(--gold); font-weight: bold; background: #000; border: 1px solid #444; border-radius: 6px; }
        
        .jogo { background: var(--panel); border: 1px solid #333; padding: 12px; border-radius: 12px; margin-bottom: 10px; width: 100%; }
        .match-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .team-display { flex: 1; display: flex; align-items: center; gap: 8px; font-weight: bold; font-size: 0.85em; }
        .flex-end { justify-content: flex-end; text-align: right; }

        .fase-titulo { color: var(--gold); text-align: center; font-size: 0.9em; margin: 20px 0 10px; text-transform: uppercase; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .btn-ok { background: var(--green); border: none; color: white; padding: 10px; border-radius: 6px; width: 100%; font-weight: bold; margin-top: 8px; cursor: pointer; text-transform: uppercase; font-size: 0.7em; }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--dark); z-index:1000; overflow-y:auto; padding:15px; }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab-btn active" onclick="window.openTab('aba-grupo')">TABELA</button>
        <button class="tab-btn" onclick="window.openTab('aba-matamata')">MATA-MATA</button>
        <button class="tab-btn" onclick="window.openTab('aba-hall')">üéñÔ∏è HALL</button>
        <button class="tab-btn" onclick="window.openTab('aba-config')">‚öôÔ∏è</button>
    </div>

    <div id="aba-grupo" class="content-section active">
        <div id="tabela-container"></div>
        <div id="jogos-container"></div>
    </div>

    <div id="aba-matamata" class="content-section">
        <div id="mata-mata-dinamico"></div>
    </div>

    <div id="aba-hall" class="content-section">
        <div id="lista-hall"></div>
    </div>

    <div id="aba-config" class="content-section">
        <div class="card">
            <h3 style="color:var(--gold); text-align:center">CONFIGURAR GURIS</h3>
            <div id="config-times-lista"></div>
            <button onclick="window.gerarNovoTorneio()" style="background:var(--red); color:white; width:100%; padding:15px; border:none; border-radius:8px; font-weight:bold; margin-top:15px; cursor:pointer;">üî• RESETAR E INICIAR</button>
        </div>
    </div>

    <div id="modal-historico" class="modal">
        <div style="max-width:600px; margin:auto">
            <button onclick="this.parentElement.parentElement.style.display='none'" style="background:var(--red); color:white; padding:10px; border:none; border-radius:5px; margin-bottom:20px;">FECHAR HIST√ìRICO</button>
            <div id="conteudo-detalhado"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://torneiodosguri-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let localData = null;

        window.openTab = (id) => {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        };

        // Escuta o Banco de Dados
        onValue(ref(db, 'campeonato/'), (snap) => {
            const data = snap.val(); if(!data) return;
            localData = data;
            atualizarInterface();
        });

        function atualizarInterface() {
            const duplas = localData.duplas || [];
            const placares = localData.placares || {};
            const ordem = localData.ordemJogos || [];

            // 1. Processar Tabela
            let stats = duplas.map(d => ({ ...d, p:0, j:0, v:0, sg:0 }));
            ordem.forEach(o => {
                const p = placares[o.key];
                if(p && p.f) {
                    const t1 = stats[o.i], t2 = stats[o.j];
                    t1.j++; t2.j++;
                    if(p.g1 > p.g2) { t1.p += 3; t1.v++; }
                    else if(p.g2 > p.g1) { t2.p += 3; t2.v++; }
                    else { t1.p++; t2.p++; }
                    t1.sg += (p.g1 - p.g2); t2.sg += (p.g2 - p.g1);
                }
            });
            stats.sort((a,b) => b.p - a.p || b.sg - a.sg);

            // 2. Render Tabela
            document.getElementById('tabela-container').innerHTML = `
                <div class="card"><table><thead><tr><th>Pos</th><th style="text-align:left">Guri</th><th>P</th><th>J</th><th>SG</th></tr></thead>
                <tbody>${stats.map((s,i) => `<tr><td>${i+1}¬∫</td><td style="text-align:left">${s.nome}</td><td>${s.p}</td><td>${s.j}</td><td>${s.sg}</td></tr>`).join('')}</tbody></table></div>`;

            // 3. Render Jogos
            document.getElementById('jogos-container').innerHTML = ordem.map(o => {
                const p = placares[o.key] || {g1:0, g2:0, f:false};
                return `<div class="jogo"><div class="match-row"><div class="team-display flex-end">${duplas[o.i].nome}</div><input type="number" id="g1-${o.key}" value="${p.g1}" class="score-input"> X <input type="number" id="g2-${o.key}" value="${p.g2}" class="score-input"><div class="team-display">${duplas[o.j].nome}</div></div><button class="btn-ok" onclick="window.salvarGrupo('${o.key}')">SALVAR</button></div>`;
            }).join('');

            renderizarMataMata(stats);
        }

        window.salvarGrupo = (key) => {
            const g1 = parseInt(document.getElementById(`g1-${key}`).value) || 0;
            const g2 = parseInt(document.getElementById(`g2-${key}`).value) || 0;
            update(ref(db, `campeonato/placares/${key}`), { g1, g2, f: true });
        };

        function renderizarMataMata(classificados) {
            const container = document.getElementById('mata-mata-dinamico');
            container.innerHTML = "";
            const total = classificados.length;
            const fases = [];

            if (total > 16) fases.push({ nome: "Oitavas de Final", qtd: 8, prefix: "oitava" });
            if (total > 8) fases.push({ nome: "Quartas de Final", qtd: 4, prefix: "quarta" });
            fases.push({ nome: "Semifinais", qtd: 2, prefix: "semi" });
            fases.push({ nome: "Grande Final", qtd: 1, prefix: "final" });

            fases.forEach((fase, fIdx) => {
                container.innerHTML += `<div class="fase-titulo">${fase.nome}</div>`;
                for (let i = 0; i < fase.qtd; i++) {
                    const key = `${fase.prefix}_${i}`;
                    const p = (localData.placares || {})[key] || { t1: null, t2: null, g1: 0, g2: 0, f: false };

                    // Preenchimento autom√°tico da 1¬™ fase
                    if (fIdx === 0 && !p.t1 && classificados.length >= fase.qtd * 2) {
                        p.t1 = classificados[i];
                        p.t2 = classificados[fase.qtd * 2 - 1 - i];
                        update(ref(db, `campeonato/placares/${key}`), { t1: p.t1, t2: p.t2 });
                    }

                    container.innerHTML += `
                        <div class="jogo">
                            <div class="match-row">
                                <div class="team-display flex-end">${p.t1 ? p.t1.nome : '?'}</div>
                                <input type="number" id="g1-${key}" value="${p.g1}" class="score-input"> X <input type="number" id="g2-${key}" value="${p.g2}" class="score-input">
                                <div class="team-display">${p.t2 ? p.t2.nome : '?'}</div>
                            </div>
                            <button class="btn-ok" onclick="window.avancarMataMata('${key}', '${fases[fIdx+1]?.prefix || 'fim'}', ${i})">AVAN√áAR</button>
                        </div>`;
                }
            });
        }

        window.avancarMataMata = (key, proxFase, index) => {
            const g1 = parseInt(document.getElementById(`g1-${key}`).value) || 0;
            const g2 = parseInt(document.getElementById(`g2-${key}`).value) || 0;
            if (g1 === g2) return alert("Mata-mata precisa de um vencedor!");
            
            const p = localData.placares[key];
            const vencedor = g1 > g2 ? p.t1 : p.t2;
            const updates = {};
            updates[`campeonato/placares/${key}/g1`] = g1;
            updates[`campeonato/placares/${key}/g2`] = g2;
            updates[`campeonato/placares/${key}/f`] = true;

            if (proxFase === 'fim') {
                update(ref(db), updates);
                window.arquivarCampeonato(vencedor, g1, g2, p.t1.nome, p.t2.nome);
            } else {
                const proxIdx = Math.floor(index / 2);
                const pos = index % 2 === 0 ? 't1' : 't2';
                updates[`campeonato/placares/${proxFase}_${proxIdx}/${pos}`] = vencedor;
                update(ref(db), updates);
            }
        };

        window.arquivarCampeonato = (vencedor, g1, g2, n1, n2) => {
            const stats = document.querySelector('#tabela-container table').innerHTML;
            const snapshot = {
                campeao: vencedor.nome,
                timeID: vencedor.timeID,
                data: new Date().toLocaleString(),
                tabelaHTML: stats,
                final: `${n1} ${g1} x ${g2} ${n2}`
            };
            push(ref(db, 'hall/'), snapshot).then(() => alert("üèÜ CAMPE√ÉO: " + vencedor.nome));
        };

        onValue(ref(db, 'hall/'), (snap) => {
            const data = snap.val() || {};
            document.getElementById('lista-hall').innerHTML = Object.entries(data).reverse().map(([id, h]) => `
                <div class="card" style="text-align:center">
                    <img src="https://media.api-sports.io/football/teams/${h.timeID}.png" class="logo-img" style="width:40px;height:40px">
                    <h3>${h.campeao}</h3>
                    <small>${h.data}</small><br>
                    <button class="btn-ok" style="background:var(--accent)" onclick="window.verDetalhes('${id}')">VER DETALHES</button>
                </div>`).join('');
            window.hallLocal = data;
        });

        window.verDetalhes = (id) => {
            const h = window.hallLocal[id];
            document.getElementById('conteudo-detalhado').innerHTML = `
                <h2 style="color:var(--gold)">Edi√ß√£o Encerrada</h2>
                <div class="card"><b>FINAL:</b><br>${h.final}</div>
                <div class="card"><b>CLASSIFICA√á√ÉO:</b><br><table>${h.tabelaHTML}</table></div>`;
            document.getElementById('modal-historico').style.display = 'block';
        };

        // Configura√ß√£o de In√≠cio
        const listaConfig = document.getElementById('config-times-lista');
        for(let i=0; i<8; i++) {
            listaConfig.innerHTML += `<input type="text" id="conf-n-${i}" placeholder="Guri ${i+1}" style="width:100%; padding:10px; margin-bottom:5px; background:#000; color:#fff; border:1px solid #444;">`;
        }

        window.gerarNovoTorneio = () => {
            if(!confirm("Resetar campeonato?")) return;
            const duplas = [];
            for(let i=0; i<8; i++){
                const nome = document.getElementById(`conf-n-${i}`).value || `Guri ${i+1}`;
                duplas.push({ nome, timeID: "541" });
            }
            const ordem = [];
            for(let i=0; i<duplas.length; i++) for(let j=i+1; j<duplas.length; j++) 
                ordem.push({ i, j, key: `jg_${i}_${j}` });
            
            set(ref(db, 'campeonato/'), { 
                duplas, 
                placares: {}, 
                ordemJogos: ordem.sort(() => Math.random() - 0.5) 
            });
            window.openTab('aba-grupo');
        };
    </script>
</body>
</html>
